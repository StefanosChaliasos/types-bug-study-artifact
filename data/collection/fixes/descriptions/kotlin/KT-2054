Test for JetDiagnosticsTest:

{code}
fun bar() {
    fun fib() = fib()
}
{code}

crashes with:

{code}
java.lang.IllegalStateException: Rewrite at slice RESOLUTION_SCOPE key: REFERENCE_EXPRESSION old value: WritableScopeImpl@3354037e Function inner scope for org.jetbrains.jet.lang.descriptors.SimpleFunctionDescriptorImpl@1726401631@861143934 new value: WritableScopeImpl@2cf63e26 Function inner scope for internal final fun fib() : <root> defined in bar[SimpleFunctionDescriptorImpl@66e6cc5f]@754335270
	at org.jetbrains.jet.util.slicedmap.Slices$1.processRewrite(Slices.java:36)
	at org.jetbrains.jet.util.slicedmap.SlicedMapImpl.put(SlicedMapImpl.java:64)
	at org.jetbrains.jet.lang.resolve.BindingTraceContext.record(BindingTraceContext.java:69)
	at org.jetbrains.jet.lang.resolve.ObservableBindingTrace.record(ObservableBindingTrace.java:56)
	at org.jetbrains.jet.lang.resolve.calls.CallResolver.doResolveCall(CallResolver.java:261)
	at org.jetbrains.jet.lang.resolve.calls.CallResolver.resolveFunctionCall(CallResolver.java:244)
	at org.jetbrains.jet.lang.resolve.calls.CallResolver.resolveFunctionCall(CallResolver.java:127)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingContext.resolveCall(ExpressionTypingContext.java:164)
	at org.jetbrains.jet.lang.types.expressions.BasicExpressionTypingVisitor.visitCallExpression(BasicExpressionTypingVisitor.java:664)
	at org.jetbrains.jet.lang.types.expressions.BasicExpressionTypingVisitor.visitCallExpression(BasicExpressionTypingVisitor.java:63)
	at org.jetbrains.jet.lang.psi.JetCallExpression.accept(JetCallExpression.java:45)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.visitJetElement(ExpressionTypingVisitorDispatcher.java:234)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.visitJetElement(ExpressionTypingVisitorDispatcher.java:37)
	at org.jetbrains.jet.lang.psi.JetVisitor.visitExpression(JetVisitor.java:148)
	at org.jetbrains.jet.lang.psi.JetVisitor.visitCallExpression(JetVisitor.java:244)
	at org.jetbrains.jet.lang.psi.JetCallExpression.accept(JetCallExpression.java:45)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:133)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:105)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorForStatements.visitExpression(ExpressionTypingVisitorForStatements.java:256)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorForStatements.visitExpression(ExpressionTypingVisitorForStatements.java:49)
	at org.jetbrains.jet.lang.psi.JetVisitor.visitCallExpression(JetVisitor.java:244)
	at org.jetbrains.jet.lang.psi.JetCallExpression.accept(JetCallExpression.java:45)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:133)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:114)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.collectReturnedExpressionsWithTypes(ExpressionTypingServices.java:210)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.inferFunctionReturnType(ExpressionTypingServices.java:144)
	at org.jetbrains.jet.lang.resolve.DescriptorResolver$1.compute(DescriptorResolver.java:210)
	at org.jetbrains.jet.lang.resolve.DescriptorResolver$1.compute(DescriptorResolver.java:206)
	at org.jetbrains.jet.util.lazy.LazyValue.get(LazyValue.java:48)
	at org.jetbrains.jet.lang.types.DeferredType.getActualType(DeferredType.java:53)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:140)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:105)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorForStatements.visitExpression(ExpressionTypingVisitorForStatements.java:256)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorForStatements.visitExpression(ExpressionTypingVisitorForStatements.java:49)
	at org.jetbrains.jet.lang.psi.JetVisitor.visitCallExpression(JetVisitor.java:244)
	at org.jetbrains.jet.lang.psi.JetCallExpression.accept(JetCallExpression.java:45)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:133)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:114)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.checkFunctionReturnType(ExpressionTypingServices.java:185)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.checkFunctionReturnType(ExpressionTypingServices.java:161)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorForStatements.visitNamedFunction(ExpressionTypingVisitorForStatements.java:131)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorForStatements.visitNamedFunction(ExpressionTypingVisitorForStatements.java:49)
	at org.jetbrains.jet.lang.psi.JetNamedFunction.accept(JetNamedFunction.java:47)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:133)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:112)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.getBlockReturnedTypeWithWritableScope(ExpressionTypingServices.java:303)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.getBlockReturnedType(ExpressionTypingServices.java:199)
	at org.jetbrains.jet.lang.types.expressions.BasicExpressionTypingVisitor.visitBlockExpression(BasicExpressionTypingVisitor.java:517)
	at org.jetbrains.jet.lang.types.expressions.BasicExpressionTypingVisitor.visitBlockExpression(BasicExpressionTypingVisitor.java:513)
	at org.jetbrains.jet.lang.types.expressions.BasicExpressionTypingVisitor.visitBlockExpression(BasicExpressionTypingVisitor.java:63)
	at org.jetbrains.jet.lang.psi.JetBlockExpression.accept(JetBlockExpression.java:45)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.visitJetElement(ExpressionTypingVisitorDispatcher.java:234)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.visitJetElement(ExpressionTypingVisitorDispatcher.java:37)
	at org.jetbrains.jet.lang.psi.JetVisitor.visitExpression(JetVisitor.java:148)
	at org.jetbrains.jet.lang.psi.JetVisitor.visitBlockExpression(JetVisitor.java:276)
	at org.jetbrains.jet.lang.psi.JetBlockExpression.accept(JetBlockExpression.java:45)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:133)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:105)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingVisitorDispatcher.getType(ExpressionTypingVisitorDispatcher.java:110)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.checkFunctionReturnType(ExpressionTypingServices.java:185)
	at org.jetbrains.jet.lang.types.expressions.ExpressionTypingServices.checkFunctionReturnType(ExpressionTypingServices.java:161)
	at org.jetbrains.jet.lang.resolve.BodyResolver.resolveFunctionBody(BodyResolver.java:557)
	at org.jetbrains.jet.lang.resolve.BodyResolver.resolveFunctionBodies(BodyResolver.java:541)
	at org.jetbrains.jet.lang.resolve.BodyResolver.resolveBehaviorDeclarationBodies(BodyResolver.java:113)
	at org.jetbrains.jet.lang.resolve.TopDownAnalyzer.doProcess(TopDownAnalyzer.java:155)
	at org.jetbrains.jet.lang.resolve.TopDownAnalyzer.analyzeFiles(TopDownAnalyzer.java:277)
	at org.jetbrains.jet.lang.resolve.java.AnalyzerFacadeForJVM.analyzeFilesWithJavaIntegration(AnalyzerFacadeForJVM.java:99)
	at org.jetbrains.jet.checkers.JetDiagnosticsTest.runTest(JetDiagnosticsTest.java:174)
	at com.intellij.testFramework.UsefulTestCase.defaultRunBare(UsefulTestCase.java:284)
	at com.intellij.testFramework.UsefulTestCase$3.run(UsefulTestCase.java:296)
	at java.awt.event.InvocationEvent.dispatch(InvocationEvent.java:199)
	at java.awt.EventQueue.dispatchEventImpl(EventQueue.java:682)
	at java.awt.EventQueue.access$000(EventQueue.java:85)
	at java.awt.EventQueue$1.run(EventQueue.java:643)
	at java.awt.EventQueue$1.run(EventQueue.java:641)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.security.AccessControlContext$1.doIntersectionPrivilege(AccessControlContext.java:87)
	at java.awt.EventQueue.dispatchEvent(EventQueue.java:652)
	at java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:296)
	at java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:211)
	at java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:201)
	at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:196)
	at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:188)
	at java.awt.EventDispatchThread.run(EventDispatchThread.java:122)

{code}